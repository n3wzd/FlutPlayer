# FlutPlayer
음원을 재생하는 안드로이드 애플리케이션입니다.

![example](example.png)

- 오디오
	- 재생 슬라이더
	- 재생 / 일시정지
	- 다음 트랙 이동, 이전 트랙 이동
	- 셔플, 반복 재생 모드
	- mashup 모드
	- 볼륨 조절
- 재생 목록
	- 목록 정렬, 목록 초기화
	- 음원 이동 (드래그 앤 드랍)
	- 음원 제거 (스와이프)
- 태그
	- 선택한 태그를 재생 목록으로 불러오기
	- 태그 추가, 업데이트, 삭제
	- 태그 즐겨찾기 기능
	- 데이터베이스 저장
- 이퀄라이저
	- 밴드의 게인 값 조절
	- 스무스 슬라이더 이동
- 배경
	- 로컬 파일 내 배경 파일 선택 가능
	- 이미지 배경 회전, 확대/축소, 색상 필터링 여부 설정
	- 배경 밝기 조절
	- 기본 애니메이션 백그라운드
- NCS(NoCopyrightSounds) 비주얼라이저
	- 색상 설정
- 설정
	- 태그, 정렬, mashup, 이퀄라이저, 배경, 비주얼라이저
	- 데이터베이스, CSV 파일 내보내기 / 불러오기
- 기타
	- 백그라운드 프로세스 지원
	- 알림바 UI 제공

## 기술 스택
- Flutter

## Dependency
- just_audio: ^0.9.35
- audioplayers: ^5.2.0
- file_picker: ^6.0.0
- permission_handler: ^11.0.1
- audio_service: ^0.18.12
- sqflite: ^2.3.0
- sqflite_common_ffi: ^2.3.0
- shared_preferences: ^2.2.2
- video_player: ^2.8.2

## 파일 구조

```
app/
│
├── components/: 기능 UI 위젯
│   ├── action_button.dart: 오디오 플레이어 컨트롤 버튼 위젯
│   ├── background.dart: 백그라운드 위젯
│   ├── fade_inout_widget.dart: 페이드 인/아웃 애니메이션 위젯
│   ├── optional_visibility.dart: 위젯 가시성 설정 위젯
│   ├── stream_builder.dart: StreamBuilder 빌더 함수 클래스
│   ├── tag_export_dialog.dart: 태그 내보내기 다이얼로그 함수
│   └── visualizer.dart: 오디오 비주얼라이저 위젯
│
├── models/: 클래스, 상수 데이터
│   ├── api.dart: API 결과 클래스
│   ├── color.dart: 색상 데이터 클래스
│   ├── data.dart: 오디오 관련 클래스
│   └── enum.dart: 상수 enum
│
├── screens/: 레이아웃 UI 위젯
│   ├── background_select.dart: 배경 선택 페이지 UI 위젯
│   ├── bottom.dart: 하단 섹션 UI 위젯
│   ├── center.dart: 센터 섹션 UI 위젯
│   ├── drawer.dart: 페이지 드로어 UI 위젯
│   ├── equalizer.dart: 이퀄라이저 컨트롤 UI 위젯
│   ├── item_add_actions.dart: 오디오별 옵션 선택기 UI 위젯
│   ├── list_sheet.dart: 음악 재생 목록 시트 UI 위젯
│   ├── tag_select.dart: 태그 선택 페이지 UI 위젯
│   └── top_menu.dart: 상단 섹션 UI 위젯
│
├── utils/: 유틸리티 클래스 및 메서드
│   ├── audio_handler.dart: 백그라운드 오디오 서비스 클래스
│   ├── audio_manager.dart: 오디오 관리 싱글톤 클래스
│   ├── audio_player.dart: 외부 오디오 패키지, AudioManager간 인터페이스 클래스
│   ├── database_interface.dart: 외부 데이터베이스 패키지, DatabaseManager간 인터페이스 클래스
│   ├── database_manager.dart: 데이터베이스 관리 싱글톤 클래스
│   ├── playlist.dart: 재생 목록 싱글톤 클래스
│   ├── preference.dart: 설정 관리 싱글톤 클래스입니다.
│   └── stream_controller.dart: StreamController 제공 클래스
│
├── widgets/: 공통 위젯
│   ├── button.dart: 버튼 위젯
│   ├── checkbox.dart: 체크박스 위젯
│   ├── dialog.dart: 다이얼로그 함수
│   ├── listtile.dart: 리스트타일 위젯
│   ├── scrollbar.dart: 스크롤바 위젯
│   ├── slider.dart: 슬라이더 위젯
│   ├── switch.dart: 스위치 버튼 위젯
│   ├── text.dart: 텍스트 위젯
│   └── text_field.dart: 텍스트 박스 위젯
│
├── global.dart: 전역 프로퍼티 & 메서드
└── main_page.dart: 메인 레이아웃 UI
```

### global.dart
전역에서 사용되는 프로퍼티, 메서드를 정의합니다.

- 앱 초기화
- 플랫폼 체크 (안드로이드, 윈도우, 웹 플랫폼)
- 전체 화면 모드
- 플레이리스트 스크롤 위치 저장
- 배경 이미지 경로 관리

### main_page.dart
앱의 메인 화면을 구성하는 UI 위젯입니다.

|위젯|기능|
|---|---|
|MainPage|메인 화면을 담당하는 위젯입니다. 초기화와 메모리 해제를 담당하며, WillPopScope를 이용하여 뒤로 가기 버튼을 처리합니다.|
|ScreenPage|메인 화면의 내용을 담당하는 StatelessWidget입니다. 전체 화면 여부에 따라 ScreenPageNormalScreen 또는 ScreenPageFullscreen를 반환합니다.|
|ScreenPageFullscreen|전체 화면 모드에서의 화면을 구성합니다. 전체 화면으로 보여지는 재생 컨트롤러와 버튼 등이 포함됩니다.|
|ScreenPageNormalScreen|전체 화면이 아닐 때의 화면을 구성합니다. 하단 섹션을 표시합니다.|
|ScreenPageCenter|화면 중앙에 배치되는 내용을 구성합니다. 배경과 함께 중앙 섹션을 표시합니다.|

### components
재사용 가능한 기능 UI 위젯들을 포함합니다.

#### action_button.dart
다양한 오디오 플레이어 컨트롤 버튼 위젯을 정의합니다.

|위젯|기능|
|---|---|
|`FullscreenButton`|전체 화면 전환 버튼|
|`SeekToPreviousButton`|이전 트랙으로 이동하는 버튼|
|`SeekToNextButton`|다음 트랙으로 이동하는 버튼|
|`PlayButton`|재생 및 일시정지 버튼|
|`ShuffleButton`|재생 목록 셔플 버튼|
|`LoopButton`|재생 반복 모드 전환 버튼|

#### background.dart
백그라운드를 제어하는 위젯을 정의합니다.

|위젯|기능|
|---|---|
|`Background`|배경을 제어하는 메인 위젯입니다. 배경은 이미지 또는 비디오로 제공될 수 있으며, 현재 재생 중인 오디오에 따라 동적으로 변경됩니다.|
|`DefaultBackground`|기본 배경을 나타내는 위젯입니다. 비주얼라이저 색상 애니메이션이 적용합니다.|
|`ImageBackground`|이미지 배경을 나타내는 위젯입니다. 주어진 이미지를 회전하거나 확대/축소하는 등의 애니메이션이 적용될 수 있습니다.|
|`VideoBackground`|비디오 배경을 나타내는 위젯입니다. 주어진 비디오를 재생하고 반복합니다.|
|`FileBackground`|파일 배경을 사용하는 공통 위젯입니다. 투명도 및 색상 조절 기능을 포함하며, 부드러운 트랜지션이 적용되어 있습니다.|

비디오 플레이어는 `video_player` 패키지를 사용합니다.

#### fade_inout_widget.dart
터치에 반응하여 페이드 인/아웃 애니메이션을 적용하는 위젯입니다. 터치를 감지하면 위젯이 나타나고, 지정된 시간이 지나면 서서히 사라집니다.

#### optional_visibility.dart
위젯의 가시성을 설정하는 유틸리티 클래스입니다. 각 메서드는 특정 조건에 따라 자식 위젯을 표시하거나 숨깁니다. 이 조건은 `AudioStreamBuilder`에서 가져온 데이터에 의해 결정됩니다.

#### stream_builder.dart
다양한 오디오 스트림 이벤트에 대한 `StreamBuilder`를 제공하는 유틸리티 클래스입니다. 각 메서드는 특정 오디오 스트림 이벤트에 대한 `StreamBuilder`를 생성하고 반환합니다. 이벤트에 따라 해당하는 빌더 함수가 호출되어 UI가 업데이트됩니다.

#### tag_export_dialog.dart
태그를 내보내는 다이얼로그 표시 함수입니다. 사용자는 다이얼로그에 태그 이름을 입력하고 확인 버튼을 클릭하여 태그를 내보낼 수 있습니다.

내보내기가 성공적으로 이루어지면 선택한 태그 이름이 onCompleted 콜백 함수로 전달됩니다. 선택한 이름이 이미 존재하는 경우나 입력이 비어있는 경우에는 적절한 경고 메시지가 표시됩니다.

#### visualizer.dart
오디오 비주얼라이저 위젯을 정의합니다.

|위젯|기능|
|---|---|
|VisualizerController|오디오 시각화를 제어하는 위젯입니다. 오디오의 바이트 스트림에 따라 원 모양의 비주얼라이저가 부드럽게 변화합니다.|
|CircleVisualizer|실제 시각화를 나타내는 비주얼라이저 위젯입니다. 지정된 크기와 색상의 원 모양을 그립니다.|


비주얼라이저 제어 과정은 다음과 같습니다:
```
1. 현재 재생 중인 오디오의 바이트 데이터를 받아옵니다.
2. 바이트 데이터를 기반으로 현재 재생 위치에서 샘플을 추출합니다. (리틀 엔디안 사용)
    - 샘플의 길이는 표준 비트 깊이(예: 16비트)입니다.
3. 샘플에서 RMS 값을 계산합니다.
4. 찾은 RMS을 통해 비주얼라이저의 애니메이션을 제어합니다.
```

RMS 값은 주어진 시간 동안의 오디오 신호의 에너지를 나타내며, 이를 통해 음악의 강도를 추정할 수 있습니다.

### models
클래스, 상수 데이터를 포함합니다.

#### api.dart
API의 결과를 정의하는 자료 구조 클래스를 정의합니다.

#### color.dart
색상 데이터를 정의하는 클래스입니다. 색상 변환 함수가 포함되어 있습니다.

#### data.dart
오디오 관련 자료 구조 클래스를 정의합니다.

|클래스|기능|
|---|---|
|`AudioTrack`|오디오 데이터 클래스|
|`BackgroundData`|백그라운드 데이터 클래스|
|`FileAudioSource`|오디오 파일 관련 클래스. 바이트 스트림 분석 기능을 포함합니다.|

#### enum.dart
다양한 상수 enum을 정의합니다. 일부 enum은 문자열간 변환 기능을 포함합니다.

### screens
레이아웃 UI 위젯을 포함합니다.

#### background_select.dart
배경 선택 페이지를 구성하는 UI 위젯입니다. 사용자는 원하는 배경을 선택하고 해당 배경을 적용할 수 있습니다.

- 오디오 트랙별로 배경을 선택하고 설정할 수 있습니다.
- 이미지 또는 비디오 파일의 경로를 입력하거나 파일 선택기를 사용하여 배경 파일을 선택할 수 있습니다.
    - 유의사항: 파일 선택기 사용시, 캐시 파일이 적용됩니다.
- 이미지 배경의 회전, 확대/축소, 색상 필터링 여부를 설정할 수 있습니다.
- 배경의 밝기를 조절할 수 있습니다.

#### bottom.dart
하단 섹션을 구성하는 UI 위젯입니다.

- 오디오 트랙의 현재 위치를 슬라이더로 표시하고 조절할 수 있습니다.
- 슬라이더 아래에는 현재 위치와 트랙의 전체 재생 시간이 표시됩니다.
- 다양한 오디오 제어 버튼을 표시하고 클릭할 수 있습니다. (셔플, 이전 트랙으로 이동, 재생/일시 정지, 다음 트랙으로 이동, 반복 재생)

#### center.dart
센터 섹션을 구성하는 UI 위젯입니다.

- NCS(NoCopyrightSounds) 로고를 표시합니다.
- 비주얼라이저를 표시합니다.
- 오디오의 제목을 표시합니다. 터치하면 스크롤 애니메이션이 표시됩니다.

#### drawer.dart
페이지 드로어를 구성하는 UI 위젯입니다.

페이지 드로어에서는 다양한 설정 기능을 제공합니다:
- **태그**: 태그를 내보내고 가져올 수 있습니다.
- **정렬**: 재생 목록의 정렬 방법을 설정할 수 있습니다.
- **매쉬업**: 트랙 간 전환 시간과 다음 트랙으로 넘어가기까지의 랜덤 시간 범위를 설정할 수 있습니다.
- **이퀄라이저**: 이퀄라이저 설정 페이지를 열 수 있습니다.
- **배경**: 배경 화면을 설정할 수 있습니다. 배경 메소드, 디렉토리 경로를 변경하고 배경을 활성화/비활성화할 수 있습니다.
- **비주얼라이저**: 비주얼라이저를 활성화/비활성화하거나, NCS 로고를 표시/숨길 수 있습니다.
- **기타**: 인스턴트 플레이, 셔플 재로딩, 삭제 버튼 표시 여부 등을 설정할 수 있습니다.
- **고급**: 데이터베이스 내보내기 및 가져오기, CSV 파일로 태그 내보내기 및 가져오기 등의 기능이 있습니다.

#### equalizer.dart
이퀄라이저 컨트롤을 제공하는 UI 위젯입니다.

- 이퀄라이저를 전체적으로 활성화/비활성화할 수 있습니다.
- 각 밴드의 게인 값을 조절할 수 있습니다.
- 밴드 조절 시 스무스한 슬라이더 이동을 설정할 수 있습니다.
- 이퀄라이저 설정을 초기화할 수 있습니다.
- 변경된 이퀄라이저 설정은 자동으로 저장됩니다.

#### item_add_actions.dart
오디오별 옵션을 설정하는 선택기 UI 위젯입니다.

|위젯|기능|
|---|---|
|`TagSelector`|오디오 트랙에 태그를 추가할 수 있습니다. 또한 새로운 태그를 생성할 수 있습니다.|
|`ColorSelector`|오디오 트랙의 시각화 색상을 선택합니다. 다양한 색상 칩 중 하나를 선택하여 해당 트랙의 배경색으로 설정합니다.|

#### list_sheet.dart
음악 재생 목록을 표시하는 리스트 시트 UI 위젯입니다.

- 시트를 확장하거나 축소하여 보기를 변경할 수 있습니다.
    - 슬라이드 동작으로도 확장이 가능합니다.
- 재생 목록 항목을 드래그하여 재정렬할 수 있습니다.
- 재생 목록에서 항목을 스와이프하여 제거할 수 있습니다.
- 재생 목록의 각 항목에 대해 태그, 색상, 또는 배경을 설정할 수 있는 팝업 메뉴가 제공됩니다.
- 목록 초기화, 목록 정렬 버튼이 제공됩니다.

#### tag_select.dart
태그를 선택하는 페이지 UI 위젯입니다.

- 데이터베이스에서 태그 목록을 가져와서 표시합니다.
- 사용자가 선택한 태그를 재생 목록으로 가져올 수 있습니다.
    - 태그는 여러 개 선택이 가능합니다.
- 현재 재생 목록을 새로운 태그로 추가할 수 있습니다.
- 태그마다 즐겨찾기 설정/해제를 설정할 수 있습니다.
- 선택한 단일 태그를 현재 재생 목록으로 업데이트할 수 있습니다.
- 선택한 단일 태그를 삭제할 수 있습니다.
- 태그 변경 동작을 수행한 뒤, 데이터베이스에 반영됩니다.

#### top_menu.dart
상단 섹션을 구성하는 UI 위젯입니다.

- **설정 아이콘**: 설정 메뉴를 엽니다.
- **검색 버튼**: 오디오 파일 검색기를 엽니다.
- **토네이도 버튼**: Mashup 모드를 토글합니다.
- **전체 화면 버튼**: 전체 화면 모드를 토글합니다.
- **볼륨 슬라이더**: 슬라이더를 조작하여 마스터 볼륨을 조절할 수 있습니다.
    - 화면 너비가 356 이상일 때만 볼륨 슬라이더가 표시됩니다.

### utils
유틸리티 클래스 및 메서드를 제공합니다.

#### audio_handler.dart
오디오 서비스를 생성하는 함수와 오디오 핸들러를 관리하는 클래스를 정의합니다. `audio_service` 패키지를 사용합니다.

- **백그라운드 프로세스 전환**: 앱이 백그라운드 상태여도 음원은 지속적으로 재생됩니다.
- **알림바 UI 지원**: 안드로이드 메뉴 또는 잠금 화면에서 알림바 UI가 표시됩니다
- 알림 바에서 제공하는 기능은 다음과 같습니다.
    - 현재 트랙명 표시
    - 재생/일시정지
    - 다음 트랙 이동
    - 이전 트랙 이동
    - 조절 슬라이더

#### audio_manager.dart
오디오를 제어하는 싱글톤 클래스입니다.

- **오디오 플레이어 관리**:
    - 메인 오디오 플레이어와 보조 오디오 플레이어를 관리합니다.
    - 오디오 파일을 재생하고 일시정지하며 이전 또는 다음 트랙으로 이동할 수 있습니다.
    - 현재 재생 중인 오디오의 길이 및 현재 재생 위치를 표시하거나 설정할 수 있습니다.
    - 현재 오디오의 볼륨을 조절할 수 있습니다.
- **재생 목록 관리**:
    - `PlayList`와 연결되어 재생 목록을 제어할 수 있습니다.
    - 재생 목록에 오디오 트랙을 추가하거나 삭제할 수 있습니다.
    - 재생 목록을 셔플하거나 반복 재생 모드를 설정할 수 있습니다.
    - 현재 재생 중인 트랙의 인덱스를 추적하고, 이전 또는 다음 트랙으로 이동할 수 있습니다.
- **오디오 파일 열기**:
    - 파일 탐색기에서 오디오 파일을 선택하여 파일을 불러올 수 있습니다.
    - `DatabaseManager`와 연결되어 데이터베이스를 통해서 파일을 불러올 수 있습니다.
    - 불러온 파일은 `AudioTrack` 구조로 저장됩니다.
    - 바이트 스트림 분석 기능을 포함하고 있습니다.
- **mashup 모드 관리**:
    - 여러 오디오 트랙을 동시에 재생하는 mashup 모드를 지원합니다.
    - 타이머를 통해 오디오 트랙 간 전환을 관리합니다.
- **이퀄라이저 관리**:
    - 이퀄라이저를 활성화하고 이퀄라이저 설정을 조정할 수 있습니다.

mashup 모드의 동작 과정은 다음과 같습니다:
```
1. 메인 오디오 플레이어를 재생합니다.
2. 타이머가 종료되면 다음을 수행합니다.
    - 보조 오디오가 다음 트랙을 재생합니다.
    - 보조 오디오의 볼륨을 천천히 올립니다. (초기 값: 0)
    - 메인 오디오의 볼륨을 서서히 낮춥니다. (최종 값: 0)
    - 다음 타이머 시간을 설정합니다.
3. 보조 오디오 플레이어를 재생합니다.
4. 타이머가 종료되면 다음을 수행합니다.
    - 메인 오디오가 다음 트랙을 재생합니다.
    - 메인 오디오의 볼륨을 천천히 올립니다. (초기 값: 0)
    - 보조 오디오의 볼륨을 서서히 낮춥니다. (최종 값: 0)
    - 다음 타이머 시간을 설정합니다.
5. (과정 1로 이동)
```

이퀄라이저 기능은 안드로이드에서만 사용 가능합니다.

#### audio_player.dart
외부 오디오 패키지와 `AudioManager`간 인터페이스를 담당한 클래스입니다. 

안드로이드, 웹에서는 `just_audio`, 윈도우에서는 `audio_players`를 사용합니다.

#### database_interface.dart
외부 데이터베이스 패키지와 `DatabaseManager`간 인터페이스를 담당한 클래스입니다. 

안드로이드에서는 `sqflite`, 윈도우에서는 `sqflite_common_ffi`를 사용합니다.

#### database_manager.dart
데이터베이스를 제어하는 싱글톤 클래스입니다.

- **데이터베이스 초기화 및 연결**:
    - 데이터베이스를 초기화하고 연결합니다.
- **데이터베이스 관리**:
    - 데이터베이스 테이블을 생성하고 삭제할 수 있습니다.
    - 데이터베이스 테이블에 오디오 트랙을 추가하거나 제거할 수 있습니다.
    - 데이터베이스 테이블의 즐겨찾기 상태를 토글할 수 있습니다.
    - 재생 목록을 데이터베이스에 내보내거나 삭제하고 업데이트할 수 있습니다.
- **데이터베이스 내/외부 파일 처리**:
    - 데이터베이스 파일을 내보내거나 가져올 수 있습니다.
    - CSV 파일로 데이터베이스 내용을 내보내거나 CSV 파일에서 데이터베이스로 가져올 수 있습니다.

#### playlist.dart
재생 목록을 관리하는 싱글톤 클래스입니다.

- 재생 목록에 오디오 트랙을 추가, 제거, 이동할 수 있습니다.
- 현재 재생 중인 오디오 트랙의 제목, 경로, 색상, 배경 데이터 등을 가져올 수 있습니다.
- 재생 목록을 셔플하거나 정렬할 수 있습니다.
- 오디오 트랙의 제목 또는 수정된 날짜를 기준으로 재생 목록을 오름차순 또는 내림차순으로 정렬할 수 있습니다.
- 재생 목록을 초기화할 수 있습니다.

#### preference.dart
다양한 설정 데이터를 관리하는 싱글톤 클래스입니다. 패키지 `shared_preferences`를 사용합니다.

- 설정들을 불러올 수 있습니다.
- 특정 설정을 변경할 수 있습니다.

#### stream_controller.dart
다양한 `StreamController`를 제공하는 클래스입니다.

### widgets
공통 위젯을 포함합니다.

#### button.dart
버튼을 생성하는 클래스입니다.

|위젯|기능|
|---|---|
|textButton|텍스트 버튼|
|iconButton|아이콘 버튼|

#### checkbox.dart
체크박스를 생성하는 클래스입니다.

#### dialog.dart
다이얼로그를 생성하는 클래스입니다.

|위젯|기능|
|---|---|
|alertDialog|단일 버튼 다이얼로그|
|choiceDialog|2개의 버튼 다이얼로그|

#### listtile.dart
리스트타일을 생성하는 클래스입니다.

|위젯|기능|
|---|---|
|multiItem|여러 항목을 표시할 때 사용되는 ListTile|
|title|제목을 포함하는 ListTile|
|content|컨테이너 ListTile|
|contentSwitch|스위치를 포함하는 ListTile|
|contentContainer|`Container` 위젯을 포함하는 컨테이너 ListTile|
|contentDropDownMenu|드롭다운 메뉴를 포함하는 ListTile|
|contentSlider|슬라이더를 포함하는 ListTile|
|contentRangeSlider|범위 슬라이더를 포함하는 ListTile|

#### scrollbar.dart
스크롤바를 생성하는 클래스입니다.

#### slider.dart
슬라이더를 생성하는 클래스입니다.

|위젯|기능|
|---|---|
|slider|일반 슬라이더|
|rangeSlider|범위 슬라이더|

#### switch.dart
스위치 버튼을 생성하는 클래스입니다.

#### text.dart
텍스트를 생성하는 클래스입니다.

|위젯|기능|
|---|---|
|text|일반적인 텍스트 위젯|
|timeFormatText:|시간 형식 텍스트 위젯|
|outlineText|윤곽선이 추가된 텍스트 위젯|
|scrollAnimationText|스크롤 애니메이션이 적용된 텍스트 위젯으로, 텍스트가 화면 너비를 초과하는 경우 스크롤 애니메이션이 적용됩니다.|

#### text_field.dart
텍스트 박스를 생성하는 클래스입니다.
